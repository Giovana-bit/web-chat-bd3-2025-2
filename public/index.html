<!DOCTYPE html>

<html lang="pt-br">

    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CHAT V3</title>

        <!-- Importa o arquivo CSS: -->
        <link rel="stylesheet" href="styles.css">

        <!-- Importa o Jquery para a aplicaÃ§Ã£o frontend: -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
        <!-- Importa o SocketIO para a aplicaÃ§Ã£o frontend: -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>

    </head>

    <body>

        <div class="container">
        
            <h1>MongoDB Web-ChatðŸ¦©</h1>

            <form id="chat">

                <input type="text" name="username" placeholder="Digite seu usuario">
                <br />
                <input multiple type="text" name="message" placeholder="Digite sua mensagem">
                <br />
                <button type="submit">Enviar</button>
                
                <!-- Carega todas as mensagens enviadas: -->
                <div class="messages"></div>

            </form>

        </div>

        <script src="/socket.io/socket.io.js"></script>
        
        <script>
            const socket = io('http://localhost:3000');
            
            // FunÃ§Ã£o para renderizar as mensagens na tela:
            function renderMessage(message) {
                $('.messages').append('<div class="message"><strong>'
                + message.author + message.data_hora + '</strong>: '+ message.message +'</div>');
            }

            // Evento para carregar as mensagens anteriores:
            socket.on('previousMessage', function(messages) {
                for (message of messages) {
                    renderMessage(message);
                }
            });

            // Evento para receber novas mensagens:
            socket.on('receivedMessage', function(message) {
                renderMessage(message);
            });

            // Evento para o envio de mensagens:
            $('#chat').submit(function(event) {


                event.preventDefault();


                var author = $('input[name=username]').val();
                var message = $('input[name=message]').val();


                if (author.length && message.length) {


                    /* Cria um objeto javascript para recuperar a data e a hora do envio da mensagem: */
                    let data_hora_obj = new Date();


                    let data_hora_msg = `
                                            [${data_hora_obj.getDate()}/${data_hora_obj.getMonth()}/${data_hora_obj.getFullYear()}-${data_hora_obj.getHours()}:${data_hora_obj.getMinutes()}:${data_hora_obj.getSeconds()}]`;


                    var messageObject = {
                        author: author,
                        data_hora:data_hora_msg,
                        message: message,
                    };

                    // Renderiza a mensagem na tela do remetente:
                    renderMessage(messageObject);
                    
                    // Envia a mensagem para o servidor:
                    socket.emit('sendMessage', messageObject);
                }
            });

        </script>

    </body>

</html>